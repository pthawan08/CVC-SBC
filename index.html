<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏û‡∏û‡∏ä.</title>
  
  <link rel="icon" href="logo.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Prompt', sans-serif; background-color: #f4f6f9; padding-bottom: 50px; }
    .nav-pills .nav-link.active { background-color: #2c3e50; }
    .nav-pills .nav-link { color: #2c3e50; }
    .card { border: none; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .header-title { color: #2c3e50; font-weight: 600; }
    
    .check-btn { width: 100%; text-align: left; padding: 15px; margin-bottom: 10px; border: 1px solid #dee2e6; border-radius: 10px; background: white; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .check-btn:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    
    .check-btn.checked { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
    .check-icon { font-size: 1.5rem; color: #ccc; }
    .check-btn.checked .check-icon { color: #28a745; }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ */
    .check-btn.locked {
      background-color: #f8f9fa; border-color: #e9ecef; cursor: default; opacity: 0.8;
    }
    .check-btn.locked:hover { transform: none; box-shadow: none; }
    .check-btn.locked .check-icon { color: #198754; }

    .status-text { font-size: 0.8rem; margin-top: 2px; }
    .badge-subject { font-size: 0.9rem; padding: 8px 12px; border-radius: 20px; font-weight: 500; }
    .loading { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; justify-content:center; align-items:center; }
  </style>
</head>
<body>

  <div class="loading" id="loading">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
  </div>

  <div class="container mt-4">
    <h2 class="text-center mb-4 header-title">
      <img src="logo.png" onerror="this.style.display='none'" style="height: 50px; margin-right: 10px;">
      ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏û‡∏û‡∏ä.
    </h2>

    <ul class="nav nav-pills nav-fill mb-4 p-2 bg-white rounded shadow-sm" id="pills-tab" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-register">1. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-checkin">2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-dashboard" onclick="loadDashboard()">3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-stats" onclick="loadStats()">4. ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button></li>
    </ul>

    <div class="tab-content">
      
      <div class="tab-pane fade show active" id="tab-register">
        <div class="card p-4">
          <h4 class="mb-3">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
          <select class="form-select mb-3" id="reg-classname">
             <option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>
             <option value="‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà</option>
             <option value="‡∏´‡∏•‡∏±‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ñ‡∏£‡∏¥‡∏™‡πÄ‡∏ï‡∏µ‡∏¢‡∏ô">‡∏´‡∏•‡∏±‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ñ‡∏£‡∏¥‡∏™‡πÄ‡∏ï‡∏µ‡∏¢‡∏ô</option>
             <option value="‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏î‡∏≤‡∏ß‡∏¥‡∏î">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏î‡∏≤‡∏ß‡∏¥‡∏î</option>
             <option value="‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå</option>
          </select>
          <div id="studentList"></div>
          <button class="btn btn-outline-secondary w-100 mb-3" onclick="addStudentField()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
          <button class="btn btn-primary w-100" onclick="submitRegistration()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-checkin">
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
             <h4 class="mb-0">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
             <div>
                <button class="btn btn-sm btn-outline-danger me-1" onclick="clearAllChecks()"><i class="fas fa-undo me-1"></i>‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
                <button class="btn btn-sm btn-outline-primary" onclick="loadStudentList()"><i class="fas fa-sync-alt me-1"></i>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
             </div>
          </div>

          <div class="alert alert-info border-0 shadow-sm"><i class="fas fa-clock me-2"></i>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞ <strong>‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</strong> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
          
          <div class="row g-2 mb-3 bg-light p-3 rounded">
            <div class="col-md-4"><label class="small text-muted">1. ‡∏ß‡∏¥‡∏ä‡∏≤</label><select class="form-select" id="checkin-class" onchange="loadStudentList()"><option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option><option value="‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà</option><option value="‡∏´‡∏•‡∏±‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ñ‡∏£‡∏¥‡∏™‡πÄ‡∏ï‡∏µ‡∏¢‡∏ô">‡∏´‡∏•‡∏±‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ñ‡∏£‡∏¥‡∏™‡πÄ‡∏ï‡∏µ‡∏¢‡∏ô</option><option value="‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏î‡∏≤‡∏ß‡∏¥‡∏î">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏î‡∏≤‡∏ß‡∏¥‡∏î</option><option value="‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå</option></select></div>
            <div class="col-md-4"><label class="small text-muted">2. ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà</label><select class="form-select" id="checkin-week" onchange="loadStudentList()"><script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${i}</option>`);</script></select></div>
            <div class="col-md-4"><label class="small text-muted">3. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" class="form-control" id="checkin-date"></div>
          </div>

          <div class="mb-3 position-relative">
             <i class="fas fa-search position-absolute text-muted" style="top: 12px; left: 15px;"></i>
             <input type="text" id="student-search" class="form-control ps-5 rounded-pill" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onkeyup="filterStudents()">
          </div>

          <div id="checkin-list-area"><div class="text-center text-muted py-5">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div></div>
          
          <div id="submit-zone" class="d-none mt-4 p-3 border-top position-sticky bottom-0 bg-white shadow-lg rounded">
            <button class="btn btn-success w-100 btn-lg shadow-sm" onclick="submitCheckIn()">
               <i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
            </button>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-dashboard">
        <div class="card p-4">
          <h4 class="mb-3">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
          <div class="table-responsive">
            <table id="dashboardTable" class="table table-hover align-middle" style="width:100%">
              <thead class="table-light"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏ß‡∏¥‡∏ä‡∏≤</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-stats">
        <div class="card p-4">
          <h4 class="mb-3">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h4>
          <div class="card h-100 border-0 shadow-sm bg-light">
            <div class="card-body">
              <h6 class="text-center text-muted mb-4">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 1-12)</h6>
              <div style="height: 400px;"><canvas id="weeklyChart"></canvas></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <script>
    // ==========================================
    // ‚ö†Ô∏è ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    // ==========================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyfI1I-9vypMaVXQ4tpdH3mrJ6LmWGoqTDaDYEHGS1QzJeyIjKWjwTF1mNWfechYSy3/exec"; 

    const unitOptions = `
      <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢ --</option>
      <option value="Beone">Beone</option>
      <option value="Betwo">Betwo</option>
      <option value="CL">CL</option>
      <option value="Ru">Ru</option>
      <option value="Nu1">Nu1</option>
      <option value="Nu2">Nu2</option>
      <option value="Nu3">Nu3</option>
      <option value="Ns A">Ns A</option>
      <option value="Ns B">Ns B</option>
      <option value="NGP A">NGP A</option>
      <option value="NGP B">NGP B</option>
      <option value="NGP C">NGP C</option>
      <option value="V-Gen A1">V-Gen A1</option>
      <option value="V-Gen A2">V-Gen A2</option>
      <option value="V-Gen B1">V-Gen B1</option>
      <option value="V-Gen B2">V-Gen B2</option>
      <option value="V-Gen B3">V-Gen B3</option>
      <option value="Acts A">Acts A</option>
      <option value="Acts B">Acts B</option>
      <option value="Acts C">Acts C</option>
      <option value="Acts D">Acts D</option>
      <option value="‡πÄ‡∏¢‡∏£‡∏π‡∏ã‡∏≤‡πÄ‡∏•‡πá‡∏° 1">‡πÄ‡∏¢‡∏£‡∏π‡∏ã‡∏≤‡πÄ‡∏•‡πá‡∏° 1</option>
      <option value="‡πÄ‡∏¢‡∏£‡∏π‡∏ã‡∏≤‡πÄ‡∏•‡πá‡∏° 2">‡πÄ‡∏¢‡∏£‡∏π‡∏ã‡∏≤‡πÄ‡∏•‡πá‡∏° 2</option>
      <option value="Power Eagle 1">Power Eagle 1</option>
      <option value="Power Eagle 2">Power Eagle 2</option>
      <option value="Power Eagle 3">Power Eagle 3</option>
      <option value="Happiness 1">Happiness 1</option>
      <option value="Happiness 2">Happiness 2</option>
      <option value="Unity 1">Unity 1</option>
      <option value="Unity 2">Unity 2</option>
    `;

    async function callAPI(payload) {
      document.getElementById('loading').style.display = 'flex';
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        document.getElementById('loading').style.display = 'none';
        if (typeof result === 'string' && result.startsWith("Error:")) throw new Error(result);
        return result;
      } catch (error) {
        document.getElementById('loading').style.display = 'none';
        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
        throw error;
      }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    document.addEventListener('DOMContentLoaded', function() {
        try {
            const dateEl = document.getElementById('checkin-date');
            if(dateEl) dateEl.valueAsDate = new Date();
            addStudentField(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å
        } catch(e) {
            console.error("Setup error:", e);
        }
    });

    function addStudentField() {
      let html = `
      <div class="student-item mb-3 p-3 border rounded bg-light">
         <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-secondary fw-bold small"><i class="fas fa-user me-1"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
            <button type="button" onclick="this.closest('.student-item').remove()" class="btn btn-sm btn-outline-danger bg-white"><i class="fas fa-trash-alt"></i> ‡∏•‡∏ö</button>
         </div>
         <div class="row g-2">
           <div class="col-md-6"><input type="text" class="form-control s-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required></div>
           <div class="col-md-6"><input type="text" class="form-control s-nick" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" required></div>
           <div class="col-md-6"><select class="form-select s-unit" required>${unitOptions}</select></div>
           <div class="col-md-6">
             <select class="form-select s-status-select" onchange="toggleOtherInput(this)" required>
                <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì --</option>
                <option value="‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà">‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà</option>
                <option value="‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option>
                <option value="‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option>
                <option value="Other">‡∏™‡∏ñ‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏...)</option>
             </select>
             <input type="text" class="form-control s-status-other mt-2 d-none" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ (‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á, ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ã‡∏•‡∏•‡πå)">
           </div>
         </div>
      </div>`;
      const list = document.getElementById('studentList');
      if(list) list.insertAdjacentHTML('beforeend', html);
    }

    function toggleOtherInput(selectElement) {
        let input = selectElement.parentElement.querySelector('.s-status-other');
        if (selectElement.value === 'Other') {
            input.classList.remove('d-none'); input.required = true; input.focus();
        } else {
            input.classList.add('d-none'); input.value = ''; input.required = false;
        }
    }

    async function submitRegistration() {
       let classname = document.getElementById('reg-classname').value;
       if(!classname) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'warning');
       let students = [];
       let isValid = true;
       document.querySelectorAll('.student-item').forEach(el => {
           let name = el.querySelector('.s-name').value;
           let nick = el.querySelector('.s-nick').value;
           let unit = el.querySelector('.s-unit').value;
           let statusSelect = el.querySelector('.s-status-select').value;
           let statusOther = el.querySelector('.s-status-other').value;
           let finalStatus = statusSelect === 'Other' ? statusOther : statusSelect;
           if(name && nick && unit && finalStatus) {
               students.push({ fullname: name, nickname: nick, unit: unit, status: finalStatus });
           } else { isValid = false; }
       });
       if(!isValid || students.length === 0) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)', 'error');
       const res = await callAPI({ action: 'register', classname: classname, students: students });
       Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', res, 'success');
       document.getElementById('studentList').innerHTML = '';
       addStudentField();
    }

    // --- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ + ‡∏•‡πá‡∏≠‡∏Ñ) ---
    async function loadStudentList() {
      let classname = document.getElementById('checkin-class').value;
      if(!classname) return;
      let week = document.getElementById('checkin-week').value;
      const students = await callAPI({ action: 'getStudents', classname: classname });
      
      let html = '';
      if(students.length === 0) {
           html = '<div class="text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ</div>';
           document.getElementById('submit-zone').classList.add('d-none');
      } else {
           students.forEach(s => {
             let savedData = s.attendance[week-1]; 
             let isChecked = savedData && savedData !== ""; 
             
             let activeClass = "";
             let clickAction = "";
             let statusText = "";
             let iconClass = "fa-check-circle";

             if (isChecked) {
                 activeClass = "checked locked";
                 clickAction = ""; // ‡∏•‡πá‡∏≠‡∏Ñ
                 statusText = `<span class="text-success fw-bold"><i class="fas fa-lock me-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${savedData}</span>`;
                 iconClass = "fa-lock"; 
             } else {
                 activeClass = "";
                 clickAction = `onclick="toggleCheck(this)"`;
                 statusText = `<span class="text-muted">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</span>`;
             }

             html += `<div class="check-btn ${activeClass}" ${clickAction} data-row="${s.row}" data-name="${s.fullname} ${s.nickname}">
               <div>
                 <strong>${s.fullname} (${s.nickname})</strong><br>
                 <small class="text-muted">${s.unit}</small> 
                 <span class="badge bg-light text-dark ms-1 border">${s.status || '-'}</span>
                 <div class="status-text">${statusText}</div>
               </div>
               <i class="fas ${iconClass} check-icon"></i>
             </div>`;
           });
           document.getElementById('submit-zone').classList.remove('d-none');
      }
      document.getElementById('checkin-list-area').innerHTML = html;
      document.getElementById('student-search').value = ''; 
    }

    function filterStudents() {
        let input = document.getElementById('student-search');
        let filter = input.value.toLowerCase();
        let items = document.querySelectorAll('.check-btn');
        items.forEach(item => {
            let name = item.getAttribute('data-name').toLowerCase();
            if (name.includes(filter)) item.classList.remove('d-none');
            else item.classList.add('d-none');
        });
    }

    function toggleCheck(el) {
       if(el.classList.contains('locked')) return;
       el.classList.toggle('checked');
       let statusDiv = el.querySelector('.status-text');
       if(el.classList.contains('checked')){ statusDiv.innerHTML = '<span class="text-success">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>'; } 
       else { statusDiv.innerHTML = '<span class="text-muted">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</span>'; }
    }

    function clearAllChecks() {
       document.querySelectorAll('.check-btn.checked:not(.locked)').forEach(el => {
           toggleCheck(el);
       });
       const toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
       toast.fire({ icon: 'info', title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß' });
    }

    async function submitCheckIn() {
      let classname = document.getElementById('checkin-class').value;
      let week = document.getElementById('checkin-week').value;
      let checkDate = document.getElementById('checkin-date').value;
      let updates = [];
      document.querySelectorAll('.check-btn').forEach(el => {
         if (!el.classList.contains('locked')) {
             updates.push({ row: el.getAttribute('data-row'), status: el.classList.contains('checked') });
         }
      });
      if(updates.length === 0) return Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á', '‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏Ñ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏±‡∏ö', 'info');
      const res = await callAPI({ action: 'checkin', classname: classname, week: week, date: checkDate, students: updates });
      Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', res, 'success').then(() => loadStudentList());
    }

    // --- Dashboard & Stats ---
    let dataTable;
    async function loadDashboard() {
      if(dataTable) dataTable.clear().destroy();
      const data = await callAPI({ action: 'dashboard' });
      let html = '';
      data.forEach(r => {
           let badge = 'bg-secondary';
           if(r.classname.includes('‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à')) badge='bg-success';
           else if(r.classname.includes('‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô')) badge='bg-primary';
           else if(r.classname.includes('‡∏î‡∏≤‡∏ß‡∏¥‡∏î')) badge='bg-warning text-dark';
           else if(r.classname.includes('‡πÄ‡∏ã‡∏•‡∏•‡πå')) badge='bg-danger';
           html += `<tr>
             <td><small class="text-muted">${r.timestamp}</small></td>
             <td class="fw-bold">${r.fullname}</td>
             <td>${r.nickname}</td>
             <td>${r.unit}</td>
             <td><span class="badge bg-info text-dark">${r.status || '-'}</span></td>
             <td><span class="badge ${badge} rounded-pill">${r.classname}</span></td>
           </tr>`;
      });
      document.querySelector('#dashboardTable tbody').innerHTML = html;
      dataTable = $('#dashboardTable').DataTable({ language: { search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:", lengthMenu: "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" }, order: [[0, 'desc']] });
    }

    let myWeeklyChart = null;
    async function loadStats() {
      const data = await callAPI({ action: 'stats' });
      if(myWeeklyChart) myWeeklyChart.destroy();
      const ctx = document.getElementById('weeklyChart').getContext('2d');
      myWeeklyChart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: ['‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1', '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2', '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 3', '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 4', '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 5', '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 6', '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 7', '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 8', '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 9', '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 10', '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 11', '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 12'],
              datasets: [
                { label: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà', data: data['‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà'], borderColor: '#28a745', tension: 0.3 },
                { label: '‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï', data: data['‡∏´‡∏•‡∏±‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ñ‡∏£‡∏¥‡∏™‡πÄ‡∏ï‡∏µ‡∏¢‡∏ô'], borderColor: '#007bff', tension: 0.3 },
                { label: '‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏î‡∏≤‡∏ß‡∏¥‡∏î', data: data['‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏î‡∏≤‡∏ß‡∏¥‡∏î'], borderColor: '#ffc107', tension: 0.3 },
                { label: '‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå', data: data['‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå'], borderColor: '#dc3545', tension: 0.3 }
              ]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
      });
    }
  </script>
</body>
</html>
